---
title: "GullGeo"
author: "Dylan Titmuss"
date: "2023-05-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load packages
```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(geosphere)
#library(ggmap)
#library(elevatr)
#library(raster)
```

## Load data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")

gulls <- read.csv("./data/allGBBGs.csv") %>%
  filter(Band != "5AZ" & Band != "3Y7" & Band != "4N2") # remove gulls on Lunging

nests21 <- read.csv("./data/2021_GBBGnests.csv") %>%
  filter(!is.na(Lat))

nests22 <- read.csv("./data/2022_GBBGnests.csv") %>%
  filter(!is.na(NestNum), # remove nests on Lunging
         !is.na(Lat))

nests23 <- read.csv("./data/2023_GBBGnests.csv") %>%
  filter(!is.na(Lat))
```

## Create simple features obj of nest data
```{r}
# create geometry column in data frame from lat/long data
for(i in 1:nrow(nests21)) {
  nests21$geometry[i] <- st_point(x = c(nests21$Long[i], nests21$Lat[i])) %>%
    st_sfc(crs = 4326)
}
nests21_sf <- st_sf(nests21, crs = 4326)

for(i in 1:nrow(nests22)) {
  nests22$geometry[i] <- st_point(x = c(nests22$Long[i], nests22$Lat[i])) %>%
    st_sfc(crs = 4326)
}
nests22_sf <- st_sf(nests22, crs = 4326)

for(i in 1:nrow(nests23)) {
  nests23$geometry[i] <- st_point(x = c(nests23$Long[i], nests23$Lat[i])) %>%
    st_sfc(crs = 4326)
}
nests23_sf <- st_sf(nests23, crs = 4326)
```

## Create flat-color map
```{r}
basemap <- st_read("./shapefiles/Basemap") %>%
  st_transform(crs = 4326)

#highTide <- st_read("./shapefiles/Appledore_HighTide") %>%
#  st_transform(crs = 4326)

ggplot() +
  #geom_sf(data = highTide) +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_sf(data = nests22_sf, inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6184, y = 42.9927, label = "2022", fontface = "bold",
           size = 8) +
  annotate("label", x = -70.6181, y = 42.99215, label = "n = 157", size = 8) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggplot() +
  #geom_sf(data = highTide) +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_sf(data = nests23_sf, inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6184, y = 42.9927, label = "2023", fontface = "bold",
           size = 8) +
  annotate("label", x = -70.6181, y = 42.99215, label = "n = 128", size = 8) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

## Calculate nest relocation distances
```{r}
birds21 <- nests21 %>%
  dplyr::select(NestID, M.1, M.2, Location, Lat, Long) %>%
  pivot_longer(c(M.1, M.2), names_to = NULL, values_to = "Band") %>%
  relocate(Band, .after = NestID) %>%
  filter(Band != "UB",
         Band != "")

birds22 <- nests22 %>%
  dplyr::select(NestID, M.1, M.2, Location, Lat, Long) %>%
  pivot_longer(c(M.1, M.2), names_to = NULL, values_to = "Band") %>%
  relocate(Band, .after = NestID) %>%
  filter(Band != "UB",
         Band != "")

birds23 <- nests23 %>%
  dplyr::select(NestID, M.1, M.2, Location, Lat, Long) %>%
  pivot_longer(c(M.1, M.2), names_to = NULL, values_to = "Band") %>%
  relocate(Band, .after = NestID) %>%
  filter(Band != "UB",
         Band != "")

# initialize new columns
gulls$lat21 <- NA
gulls$long21 <- NA
gulls$lat22 <- NA
gulls$long22 <- NA
gulls$lat23 <- NA
gulls$long23 <- NA
gulls$dist1 <- NA
gulls$dist2 <- NA

for(i in 1:nrow(gulls)) {
  if(!identical(birds21$Lat[birds21$Band == gulls$Band[i]], numeric(0))) {
    gulls$lat21[i] <- birds21$Lat[birds21$Band == gulls$Band[i]]
    gulls$long21[i] <- birds21$Long[birds21$Band == gulls$Band[i]]
  }
  if(!identical(birds22$Lat[birds22$Band == gulls$Band[i]], numeric(0))) {
    gulls$lat22[i] <- birds22$Lat[birds22$Band == gulls$Band[i]]
    gulls$long22[i] <- birds22$Long[birds22$Band == gulls$Band[i]]
  }
  if(!identical(birds23$Lat[birds23$Band == gulls$Band[i]], numeric(0))) {
    gulls$lat23[i] <- birds23$Lat[birds23$Band == gulls$Band[i]]
    gulls$long23[i] <- birds23$Long[birds23$Band == gulls$Band[i]]
  }
  gulls$dist1[i] <- distm(c(gulls$lat21[i], gulls$long21[i]), c(gulls$lat22[i], gulls$long22[i]),
                   fun = distHaversine)
  gulls$dist2[i] <- distm(c(gulls$lat22[i], gulls$long22[i]), c(gulls$lat23[i], gulls$long23[i]),
                   fun = distHaversine)
}
```

## Plot nest relocation histogram
```{r}
gulls$dist1_grp <- NA
gulls$dist2_grp <- NA

for(i in 1:nrow(gulls)) {
  if(!is.na(gulls$dist1[i]) & gulls$dist1[i] <= 6) {
    gulls$dist1_grp[i] <- "0"
  } else if(!is.na(gulls$dist1[i]) & gulls$dist1[i] > 6 & gulls$dist1[i] <= 10) {
    gulls$dist1_grp[i] <- "≤ 10"
  } else if(!is.na(gulls$dist1[i]) & gulls$dist1[i] > 10 & gulls$dist1[i] <= 20) {
    gulls$dist1_grp[i] <- "10 < x ≤ 20"
  } else if(!is.na(gulls$dist1[i]) & gulls$dist1[i] > 20 & gulls$dist1[i] <= 40) {
    gulls$dist1_grp[i] <- "20 < x ≤ 40"
  } else if(!is.na(gulls$dist1[i]) & gulls$dist1[i] > 40) {
    gulls$dist1_grp[i] <- "> 40"
  }
  if(!is.na(gulls$dist2[i]) & gulls$dist2[i] <= 6) {
    gulls$dist2_grp[i] <- "0"
  } else if(!is.na(gulls$dist2[i]) & gulls$dist2[i] > 6 & gulls$dist2[i] <= 10) {
    gulls$dist2_grp[i] <- "≤ 10"
  } else if(!is.na(gulls$dist2[i]) & gulls$dist2[i] > 10 & gulls$dist2[i] <= 20) {
    gulls$dist2_grp[i] <- "10 < x ≤ 20"
  } else if(!is.na(gulls$dist2[i]) & gulls$dist2[i] > 20 & gulls$dist2[i] <= 40) {
    gulls$dist2_grp[i] <- "20 < x ≤ 40"
  } else if(!is.na(gulls$dist2[i]) & gulls$dist2[i] > 40) {
    gulls$dist2_grp[i] <- "> 40"
  }
}

# rearrange data
gull_dist <- gulls %>%
  gather(dist_year, dist_grp, dist1_grp:dist2_grp) %>%
  filter(!is.na(dist_grp)) %>%
    group_by(dist_year) %>%
    summarise(grp1 = sum(dist_grp == "0") / n(),
              grp2 = sum(dist_grp == "≤ 10") / n(),
              grp3 = sum(dist_grp == "10 < x ≤ 20") / n(),
              grp4 = sum(dist_grp == "20 < x ≤ 40") / n(),
              grp5 = sum(dist_grp == "> 40") / n()) %>%
    gather(key = dist_grp, value = prop, grp1:grp5)

count(gulls[!is.na(gulls$dist1), ]) # n = 89
count(gulls[!is.na(gulls$dist2), ]) # n = 127

ggplot(gull_dist, aes(x = as.factor(dist_grp), y = prop, fill = dist_year)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual(values = c("palegreen3", "mediumpurple1"),
                    labels = c("2021-2022", "2022-2023"),
                    name = "Years\ncompared") +
  scale_x_discrete(labels = c("0", "0 < x ≤ 10", "10 < x ≤ 20", "20 < x ≤ 40", "> 40")) +
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8)) +
  labs(x = "Distance between nest sites (m)", y = "Proportion of banded adults") +
  annotate("label", x = 5, y = 0.8, label = "n = 89",
           fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = 5, y = 0.72, label = "n = 127",
           fontface = "bold",
           col = "purple3", size = 6) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"))
```

## Create individual gull relocation plots for animation
```{r}
# blank
ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6186, y = 42.9927, label = "2022", fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = -70.6186, y = 42.9922, label = "2023", fontface = "bold",
           col = "purple3", size = 6) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  annotate("segment",
           x = nests22_sf$Long[nests22_sf$M.1 == "7F9"],
           xend = nests23_sf$Long[nests23_sf$M.1 == "7F9"],
           y = nests22_sf$Lat[nests22_sf$M.1 == "7F9"],
           yend = nests23_sf$Lat[nests23_sf$M.1 == "7F9"],
           linetype = "dashed", linewidth = 0.75) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "7F9", ], shape = 21, fill = "forestgreen", size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests23_sf[nests23_sf$M.1 == "7F9", ], shape = 21, fill = "purple3", size = 4,
          inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6186, y = 42.9927, label = "2022", fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = -70.6186, y = 42.9922, label = "2023", fontface = "bold",
           col = "purple3", size = 6) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  annotate("segment",
           x = nests22_sf$Long[nests22_sf$M.1 == "7F9"],
           xend = nests23_sf$Long[nests23_sf$M.1 == "7F9"],
           y = nests22_sf$Lat[nests22_sf$M.1 == "7F9"],
           yend = nests23_sf$Lat[nests23_sf$M.1 == "7F9"],
           linetype = "dashed", linewidth = 0.75) +
  annotate("segment",
           x = nests22_sf$Long[nests22_sf$M.1 == "6FM"],
           xend = nests23_sf$Long[nests23_sf$M.1 == "6FM"],
           y = nests22_sf$Lat[nests22_sf$M.1 == "6FM"],
           yend = nests23_sf$Lat[nests23_sf$M.1 == "6FM"],
           linetype = "dashed", linewidth = 0.75) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "7F9", ], shape = 21, fill = "forestgreen", size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests23_sf[nests23_sf$M.1 == "7F9", ], shape = 21, fill = "purple3", size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "6FM", ], shape = 22, fill = "forestgreen",
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests23_sf[nests23_sf$M.1 == "6FM", ], shape = 22, fill = "purple3",
          size = 4,
          inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6186, y = 42.9927, label = "2022", fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = -70.6186, y = 42.9922, label = "2023", fontface = "bold",
           col = "purple3", size = 6) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  annotate("segment",
           x = nests22_sf$Long[nests22_sf$M.1 == "7F9"],
           xend = nests23_sf$Long[nests23_sf$M.1 == "7F9"],
           y = nests22_sf$Lat[nests22_sf$M.1 == "7F9"],
           yend = nests23_sf$Lat[nests23_sf$M.1 == "7F9"],
           linetype = "dashed", linewidth = 0.75) +
  annotate("segment",
           x = nests22_sf$Long[nests22_sf$M.1 == "6FM"],
           xend = nests23_sf$Long[nests23_sf$M.1 == "6FM"],
           y = nests22_sf$Lat[nests22_sf$M.1 == "6FM"],
           yend = nests23_sf$Lat[nests23_sf$M.1 == "6FM"],
           linetype = "dashed", linewidth = 0.75) +
  annotate("segment",
           x = nests21_sf$Long[nests21_sf$M.1 == "2Z0"],
           xend = nests22_sf$Long[nests22_sf$M.1 == "2Z0"],
           y = nests21_sf$Lat[nests21_sf$M.1 == "2Z0"],
           yend = nests22_sf$Lat[nests22_sf$M.1 == "2Z0"],
           linetype = "dashed", linewidth = 0.75) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "7F9", ], shape = 21, fill = "forestgreen", 
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests23_sf[nests23_sf$M.1 == "7F9", ], shape = 21, fill = "purple3", 
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "6FM", ], shape = 22, fill = "forestgreen", 
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests23_sf[nests23_sf$M.1 == "6FM", ], shape = 22, fill = "purple3", 
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests21_sf[nests21_sf$M.1 == "2Z0", ], shape = 24, fill = "forestgreen", 
          size = 3,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "2Z0", ], shape = 24, fill = "purple3", 
          size = 3,
          inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6186, y = 42.9927, label = "2022", fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = -70.6186, y = 42.9922, label = "2023", fontface = "bold",
           col = "purple3", size = 6) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

## Calculate mate fidelity stats: 2021-2022
```{r}
fidelity <- gulls %>%
  filter(NestID21 != "") %>%
  filter(Band != "9P3" & Band != "8K6")

count(fidelity[fidelity$NestID21 != "" & fidelity$NestID22 == "", ]) # n=24 not resighted

fidelity <- fidelity %>%
  filter(NestID22 != "")

for(i in 1:nrow(fidelity)) {
  band <- fidelity$Band[i]
  if(identical(character(0), fidelity$Band[fidelity$NestID21 == fidelity$NestID21[i] &
                                   fidelity$Band != fidelity$Band[i]])) {
    fidelity$M21[i] <- ""
  } else {
    fidelity$M21[i] <- fidelity$Band[fidelity$NestID21 == fidelity$NestID21[i] &
                                   fidelity$Band != fidelity$Band[i]]
  }
  if(identical(character(0), fidelity$Band[fidelity$NestID22 == fidelity$NestID22[i] &
                                   fidelity$Band != fidelity$Band[i]])) {
    fidelity$M22[i] <- ""
  } else {
    fidelity$M22[i] <- fidelity$Band[fidelity$NestID22 == fidelity$NestID22[i] &
                                   fidelity$Band != fidelity$Band[i]]
  }
}

fidelity$check <- fidelity$M21 == fidelity$M22

count(fidelity[fidelity$check == TRUE & fidelity$M21 == "", ])
count(fidelity[fidelity$check == TRUE & fidelity$M22 == "", ])
# n=55 unbanded mate both years

count(fidelity[fidelity$check == FALSE, ])
# n=2 different mate

count(fidelity[fidelity$check == TRUE & fidelity$M22 != "", ])
# n=38 same mate
```

## Calculate mate fidelity stats: 2022-2023
```{r}
fidelity <- gulls %>%
  filter(lat22 != "") %>%
  filter(NestID22 != "")

count(fidelity[fidelity$NestID23 == "", ]) # n=80 not resighted

fidelity <- fidelity %>%
  filter(NestID23 != "")

for(i in 1:nrow(fidelity)) {
  band <- fidelity$Band[i]
  if(identical(character(0), fidelity$Band[fidelity$NestID22 == fidelity$NestID22[i] &
                                   fidelity$Band != fidelity$Band[i]])) {
    fidelity$M22[i] <- ""
  } else {
    fidelity$M22[i] <- fidelity$Band[fidelity$NestID22 == fidelity$NestID22[i] &
                                   fidelity$Band != fidelity$Band[i]]
  }
  if(identical(character(0), fidelity$Band[fidelity$NestID23 == fidelity$NestID23[i] &
                                   fidelity$Band != fidelity$Band[i]])) {
    fidelity$M23[i] <- ""
  } else {
    fidelity$M23[i] <- fidelity$Band[fidelity$NestID23 == fidelity$NestID23[i] &
                                   fidelity$Band != fidelity$Band[i]]
  }
}

fidelity$check <- fidelity$M22 == fidelity$M23

count(fidelity[fidelity$check == TRUE & fidelity$M22 == "", ]) # 82
count(fidelity[fidelity$check == TRUE & fidelity$M23 == "", ]) # 82
# n=83 unbanded mate both years

count(fidelity[fidelity$check == FALSE, ]) # subtract 2 for 3Y5 & 8R0
# n=6 different mate (4 lost mate to HPAI)

count(fidelity[fidelity$check == TRUE & fidelity$M22 != "", ]) # add 2 for 3Y5 & 8R0
# n=38 same mate
```

## Plot mate fidelity
```{r}
status <- c("Resighted, same mate", "Resighted, different mate", "Both years unbanded mate", "Not resighted")
year <- c(rep(2022, 4))
count <- c(38, 2, 55, 24)
prop <- count / sum(count)

mates <- as.data.frame(cbind(status, year, count, prop))

year <- c(rep(2023, 4))
count <- c(38, 6, 83, 80)
prop <- count / sum(count)

mates <- rbind(mates, cbind(status, year, count, prop))

ggplot(mates, aes(x = factor(status, levels = c("Resighted, same mate", "Resighted, different mate", "Both years unbanded mate", "Not resighted")), y = as.numeric(prop), fill = year)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual(values = c("palegreen3", "mediumpurple1"),
                    labels = c("2021-2022", "2022-2023"),
                    name = "Years\ncompared") +
  labs(x = "Mating status", y = "Proportion of banded adults") +
  scale_y_continuous(limits = c(0, 0.48)) +
  annotate("label", x = 1, y = 0.45, label = "n = 119",
           fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = 1, y = 0.40, label = "n = 207",
           fontface = "bold",
           col = "purple3", size = 6) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"))
```

## Load individual data
```{r}
allgulls <- read.csv("data/allGBBGs.csv")

birds22$HatchLocation <- NA
birds22$HatchArea <- NA
birds22$HatchLat <- NA
birds22$HatchLong <- NA
birds22$dist <- NA

for(i in 1:nrow(birds22)) {
  if(allgulls$BandedAge[allgulls$Band == birds22$Band[i]] == "chick") {
    birds22$HatchLocation[i] <- allgulls$BandedLocation[allgulls$Band == birds22$Band[i]]
    birds22$HatchArea[i] <- allgulls$BandLoc_General[allgulls$Band == birds22$Band[i]]
    birds22$HatchLat[i] <- allgulls$BandedLat[allgulls$Band == birds22$Band[i]]
    birds22$HatchLong[i] <- allgulls$BandedLong[allgulls$Band == birds22$Band[i]]
    birds22$dist[i] <- distm(c(birds22$HatchLat[i], birds22$HatchLong[i]),
                             c(birds22$Lat[i], birds22$Long[i]),
                             fun = distHaversine)
  }
}

median(birds22$dist, na.rm = TRUE) # 28.86 m

chicks22_sf <- st_as_sf(birds22,
                        coords = c("Long", "Lat"),
                        crs = 4326) %>%
               filter(HatchArea != "")

birds23$HatchLocation <- NA
birds23$HatchArea <- NA
birds23$HatchLat <- NA
birds23$HatchLong <- NA
birds23$dist <- NA

for(i in 1:nrow(birds23)) {
  if(allgulls$BandedAge[allgulls$Band == birds23$Band[i]] == "chick") {
    birds23$HatchLocation[i] <- allgulls$BandedLocation[allgulls$Band == birds23$Band[i]]
    birds23$HatchArea[i] <- allgulls$BandLoc_General[allgulls$Band == birds23$Band[i]]
    birds23$HatchLat[i] <- allgulls$BandedLat[allgulls$Band == birds23$Band[i]]
    birds23$HatchLong[i] <- allgulls$BandedLong[allgulls$Band == birds23$Band[i]]
    birds23$dist[i] <- distm(c(birds23$HatchLat[i], birds23$HatchLong[i]),
                             c(birds23$Lat[i], birds23$Long[i]),
                             fun = distHaversine)
  }
}

median(birds23$dist, na.rm = TRUE) # 21.61 m

chicks23_sf <- st_as_sf(birds23,
                        coords = c("Long", "Lat"),
                        crs = 4326) %>%
               filter(HatchArea != "")
```

## Interjection: identify & output "philo" & "non-philo" birds
```{r}
philo_friends <- rbind(birds22 %>% rename(Lat = Lat, Lon = Long),
                       birds23 %>% rename(Lat = Lat, Lon = Long)) %>%
  filter(!is.na(dist))

ggplot(philo_friends, aes(x = dist)) +
  geom_histogram() +
  theme_linedraw()

quantile(philo_friends$dist, c(0, 0.333, 0.667, 1))
quantile(philo_friends$dist, c(0, 0.35, 0.85, 1)) # based on "70% philopatric"

philo_friends$philo_cat <- NA

philo_friends <- philo_friends %>%
  mutate(philo_cat = case_when(dist <= 20.522144 ~ "philo",
                               dist >= 163.649386 ~ "non-philo")) %>%
  arrange(desc(NestID)) %>%
  distinct(Band, philo_cat, .keep_all = TRUE) %>%
  filter(Band != "3FZ" & Band != "9FJ") %>%
  arrange(desc(philo_cat), Band)

write_csv(philo_friends, "philo1.csv")

most_philo <- birds23 %>%
  filter(Location == HatchLocation |
         str_detect(Location, HatchLocation) |
         str_detect(HatchLocation, Location)) %>%
  rbind(birds22 %>%
          filter(Location == HatchLocation |
          str_detect(Location, HatchLocation) |
          str_detect(HatchLocation, Location))) %>%
  distinct(Band, .keep_all = TRUE) %>%
  arrange(Lat) %>%
  filter(Band != "7U9")

write_csv(most_philo, "philo2.csv")
```

## Sub-colony testing
```{r}
testchicks <- allgulls %>%
  filter(BandedAge == "chick",
         !is.na(BandedLat),
         !str_detect(NestID22, "Lunging"))

testchicks$highlight <- ifelse(testchicks$BandedLocation == "Sunset", TRUE, FALSE)

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_point(data = testchicks, aes(x = BandedLong, y = BandedLat, col = BandedLocation, fill = highlight),
             shape = 23, size = 3, inherit.aes = FALSE) +
  scale_fill_manual(values = c("white", "white"), guide = "none") +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggsave("figures/philo/bandedGPS.png", width = 9, height = 8, units = "in", dpi = 600)

birds22.23 <- birds23 %>%
  rbind(birds22) %>%
  distinct(Band, .keep_all = TRUE) %>%
  filter(Band != "3FZ" & Band != "7U9")

ggplot(birds22.23[!is.na(birds22.23$HatchLocation), ], aes(x = Location, fill = HatchLocation)) +
  geom_bar() +
  theme_linedraw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

ggsave("figures/philo/philo_hist_base.png", width = 9, height = 6.5, units = "in", dpi = 600)

count(birds22.23[!is.na(birds22.23$HatchLocation), ], Location, HatchLocation) %>%
  filter(n > 1) %>%
  arrange(desc(n))

test22.23 <- birds22.23 %>%
  filter(!is.na(HatchLocation)) %>%
  mutate(NestArea = Location,
         HatchArea = HatchLocation) %>%
  mutate(NestArea = case_when(Location == "Grass Lab" ~ "FMS 5-Grass", ###
                              Location == "FMS 5" ~ "FMS 5-Grass", ###
                              str_detect(Location, "Laighton") ~ "Laighton-PK",
                              str_detect(Location, "Sandpiper") ~ "Sandpiper-Larus",
                              Location == "Larus" ~ "Sandpiper-Larus",
                              Location == "FMS 15" ~ "Norwegian-FMS 15", ###
                              Location == "Norwegian" ~ "Norwegian-FMS 15", ###
                              # ^round 1
                              Location == "Bartels--bench" ~ "Gerry's",
                              str_detect(Location, "Gerry's") ~ "Gerry's-stone bridge",
                              Location == "Broad--Norwegian" ~ "Norwegian",
                              str_detect(Location, "Celia's") ~ "Celia's",
                              Location == "FMS 27" ~ "FMS 27-28",
                              Location == "FMS 28" ~ "FMS 27-28",
                              str_detect(Location, "stone bridge") ~ "Gerry's-stone bridge",
                              Location == "HTP" ~ "HTP-Tidepool",
                              str_detect(Location, "Tidepool") ~ "HTP-Tidepool",
                              Location == "Paint Shed" ~ "HTP-Tidepool",
                              Location == "Siren's" ~ "FMS 14-Siren's",
                              str_detect(Location, "swale") ~ "HTP-Tidepool",
                              # ^round 2
                              # Location == "Broad N" ~ "Broad-FMS 15",
                              # Location == "HTP" ~ "HTP-Celia's",
                              # str_detect(Location, "swale") ~ "HTP-Celia's",
                              # Location == "FMS 27" ~ "FMS 27-dock",
                              # Location == "FMS 28" ~ "FMS 27-dock",
                              # Location == "FMS 23" ~ "Gerry's-incinerator",
                              # Location == "FMS 4" ~ "HTP-Celia's",
                              # Location == "dock" ~ "FMS 27-dock",
                              # Location == "HTP--dock" ~ "SWcampus",
                              # Location == "radio tower" ~ "SWcampus",
                              # # Location == "Dive Locker" ~ "HTP-Celia's",
                              # # Location == "Broad S" ~ "Broad-FMS 15",
                              # # Location == "DDF" ~ "DDF-North Head",
                              # # Location == "North Head" ~ "DDF-North Head",
                              # # Location == "Ross's Pole Barn" ~ "north-thicket",
                              .default = Location),
         HatchArea = case_when(HatchLocation == "FMS 13" ~ "Siren's",
                               HatchLocation == "FMS 5" ~ "FMS 5-Grass", ###
                               str_detect(HatchLocation, "Laighton") ~ "SWcampus",
                               str_detect(HatchLocation, "Sandpiper") ~ "Sandpiper-Larus",
                               HatchLocation == "Larus" ~ "Sandpiper-Larus",
                               HatchLocation == "FMS 15" ~ "Norwegian-FMS 15", ###
                               HatchLocation == "Norwegian" ~ "Norwegian-FMS 15", ###
                               #HatchLocation == "trail--Smith's" ~ "FMS 28", ###
                               # ^round 1
                               HatchLocation == "FMS 27" ~ "FMS 27-28",
                               HatchLocation == "FMS 28" ~ "FMS 27-28",
                               HatchLocation == "trail--Smith's" ~ "FMS 27-28",
                               HatchLocation == "Dive Locker" ~ "Dive Locker-FMS 4",
                               HatchLocation == "FMS 4" ~ "Dive Locker-FMS 4",
                               HatchLocation == "HTP" ~ "HTP-Tidepool",
                               str_detect(HatchLocation, "Paint Shed") ~ "HTP-Tidepool",
                               str_detect(HatchLocation, "waste") ~ "HTP-Tidepool",
                               HatchLocation == "dock--HTP" ~ "SWcampus",
                               HatchLocation == "FMS 14" ~ "FMS 14-Siren's",
                               HatchLocation == "Siren's" ~ "FMS 14-Siren's",
                               HatchLocation == "Gerry's" ~ "Gerry's-stone bridge",
                               # HatchLocation == "Broad" ~ "Broad-FMS 15",
                               # HatchLocation == "HTP" ~ "HTP-Celia's",
                               # str_detect(HatchLocation, "Paint") ~ "HTP-Celia's",
                               # HatchLocation == "Gerry's" ~ "Gerry's-incinerator",
                               # HatchLocation == "incinerator" ~ "Gerry's-incinerator",
                               # HatchLocation == "Dive Locker" ~ "HTP-Celia's",
                               # HatchLocation == "FMS 4" ~ "HTP-Celia's",
                               # HatchLocation == "HTP--Grass" ~ "HTP-Celia's",
                               # HatchLocation == "K House" ~ "SWcampus",
                               # HatchLocation == "wastewater trt" ~ "HTP-Celia's",
                               # HatchLocation == "dock" ~ "FMS 27-dock",
                               # HatchLocation == "dock--HTP" ~ "SWcampus",
                               # # HatchLocation == "DDF" ~ "DDF-North Head",
                               # # HatchLocation == "North Head" ~ "DDF-North Head",
                               # # HatchLocation == "Grass--DDF" ~ "north-thicket",
                               # # HatchLocation == "graveyard" ~ "north-thicket",
                               # # HatchLocation == "Ross's Pole Barn" ~ "north-thicket",
                               # # HatchLocation == "turbine" ~ "north-thicket",
                               .default = HatchLocation))

# ones <- test22.23[!is.na(test22.23$HatchArea), ] %>%
#   group_by(NestArea) %>%
#   summarise(n = n_distinct(HatchArea)) %>%
#   filter(n == 1)
# 
# ones <- test22.23[!is.na(test22.23$HatchArea), ] %>%
#   group_by(HatchArea) %>%
#   summarise(n = n_distinct(NestArea)) %>%
#   filter(n == 1)

#test22.23$highlight <- ifelse(test22.23$HatchLocation == "Broad-Gerry's", TRUE, FALSE)

ggplot(test22.23, aes(x = NestArea, fill = HatchArea)) +  # , col = highlight
  geom_bar() +
  #scale_color_manual(values = c(NA, "black"), guide = "none") +
  theme_linedraw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

ggsave("figures/philo/philo_hist_round2.png", width = 9, height = 6.5, units = "in", dpi = 600)

test22.23 %>%
  filter(NestArea == HatchArea |
         str_detect(NestArea, HatchArea) |
         str_detect(HatchArea, NestArea)) %>%
  distinct(Band, .keep_all = TRUE) %>%
  arrange(Lat) %>%
  write_csv("philo3.csv")

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_point(data = test22.23[!is.na(test22.23$HatchArea), ],
             aes(x = Long, y = Lat, col = HatchArea),
             shape = 23, size = 3, inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggsave("figures/philo/subcolonies_round1.1.png", width = 12, height = 9, units = "in", dpi = 600)

test22.23$highlight <- ifelse(test22.23$Location == "Laighton--PK", TRUE, FALSE)

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_point(data = test22.23, aes(x = Long, y = Lat, col = HatchArea, fill = highlight),
             shape = 23, size = 3, inherit.aes = FALSE) +
  scale_fill_manual(values = c("white", "black"), guide = "none") +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

birds23$highlight <- ifelse(birds23$Location == "FMS 22", TRUE, FALSE)

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_point(data = birds23, aes(x = Long, y = Lat, col = Location, fill = highlight),
             shape = 23, size = 3, inherit.aes = FALSE) +
  scale_fill_manual(values = c("white", "black"), guide = "none") +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

ggsave("figures/philo/2023location_check.png", width = 12, height = 9, units = "in", dpi = 600)
```

## Plot philopatry
```{r}
justToHelpMeFindThisSpot <- c("#F3C300", "#F38400", "#0067A5", "#875692", "#BE0032", "#848482", "#008856", "#222222", "#A86E10", "#47C3D4", "#E68FAC", "#8DB600")

palette <- c(kelly(22)[c(3, 5, 12, 4, 7, 9:10, 2)], "#A86E10", "#47C3D4", kelly(22)[c(11, 19)])

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_sf(data = st_jitter(chicks22_sf, factor = 0.005), aes(col = HatchArea), size = 3, inherit.aes = FALSE) +
  geom_sf(data = chicks22_sf[chicks22_sf$Band == "2U0" | chicks22_sf$Band == "4FE", ], aes(col = HatchArea), size = 3, inherit.aes = FALSE) +
  geom_point(data = nests22, aes(x = Long[91], y = Lat[91]), shape = 23, size = 4, col = "red") +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  scale_colour_manual(values = palette) +
  annotate("label", x = -70.6184, y = 42.9927, label = "2022", fontface = "bold",
           size = 8) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

# n = 102
71/102 # 69.6%

palette2 <- c(kelly(22)[c(3, 5, 12, 4, 7, 9:10, 2)], "#A86E10", "#47C3D4", kelly(22)[c(11, 19)])

ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_sf(data = st_jitter(chicks23_sf, factor = 0.005), aes(col = HatchArea), size = 3, inherit.aes = FALSE) +
  geom_sf(data = chicks22_sf[chicks22_sf$Band == "2U0", ], aes(col = HatchArea), size = 3, inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  scale_colour_manual(values = palette2) +
  annotate("label", x = -70.6184, y = 42.9927, label = "2023", fontface = "bold",
           size = 8) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

# n = 73
51/73 # 69.8%
```

## Group NDDs
```{r}
birds22$dist_grp <- NA

for(i in 1:nrow(birds22)) {
  if(!is.na(birds22$dist[i]) & birds22$dist[i] <= 20) {
    birds22$dist_grp[i] <- "≤ 20"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 20 & birds22$dist[i] <= 40) {
    birds22$dist_grp[i] <- "20 < x ≤ 40"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 40 & birds22$dist[i] <= 60) {
    birds22$dist_grp[i] <- "40 < x ≤ 60"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 60 & birds22$dist[i] <= 80) {
    birds22$dist_grp[i] <- "60 < x ≤ 80"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 80 & birds22$dist[i] <= 100) {
    birds22$dist_grp[i] <- "80 < x ≤ 100"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 100 & birds22$dist[i] <= 200) {
    birds22$dist_grp[i] <- "100 < x ≤ 200"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 200 & birds22$dist[i] <= 300) {
    birds22$dist_grp[i] <- "200 < x ≤ 300"
  } else if(!is.na(birds22$dist[i]) & birds22$dist[i] > 300) {
    birds22$dist_grp[i] <- "> 300"
  }
}

# rearrange data
ndd22 <- birds22 %>%
  filter(!is.na(dist_grp)) %>%
  summarise(grp1 = sum(dist_grp == "≤ 20") / n(),
            grp2 = sum(dist_grp == "20 < x ≤ 40") / n(),
            grp3 = sum(dist_grp == "40 < x ≤ 60") / n(),
            grp4 = sum(dist_grp == "60 < x ≤ 80") / n(),
            grp5 = sum(dist_grp == "80 < x ≤ 100") / n(),
            grp6 = sum(dist_grp == "100 < x ≤ 200") / n(),
            grp7 = sum(dist_grp == "200 < x ≤ 300") / n(),
            grp8 = sum(dist_grp == "> 300") / n()) %>%
  gather(key = dist_grp, value = prop, grp1:grp8)

#sum(ndd$prop)

birds23$dist_grp <- NA

for(i in 1:nrow(birds23)) {
  if(!is.na(birds23$dist[i]) & birds23$dist[i] <= 20) {
    birds23$dist_grp[i] <- "≤ 20"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 20 & birds23$dist[i] <= 40) {
    birds23$dist_grp[i] <- "20 < x ≤ 40"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 40 & birds23$dist[i] <= 60) {
    birds23$dist_grp[i] <- "40 < x ≤ 60"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 60 & birds23$dist[i] <= 80) {
    birds23$dist_grp[i] <- "60 < x ≤ 80"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 80 & birds23$dist[i] <= 100) {
    birds23$dist_grp[i] <- "80 < x ≤ 100"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 100 & birds23$dist[i] <= 200) {
    birds23$dist_grp[i] <- "100 < x ≤ 200"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 200 & birds23$dist[i] <= 300) {
    birds23$dist_grp[i] <- "200 < x ≤ 300"
  } else if(!is.na(birds23$dist[i]) & birds23$dist[i] > 300) {
    birds23$dist_grp[i] <- "> 300"
  }
}

# rearrange data
ndd23 <- birds23 %>%
  filter(!is.na(dist_grp)) %>%
  summarise(grp1 = sum(dist_grp == "≤ 20") / n(),
            grp2 = sum(dist_grp == "20 < x ≤ 40") / n(),
            grp3 = sum(dist_grp == "40 < x ≤ 60") / n(),
            grp4 = sum(dist_grp == "60 < x ≤ 80") / n(),
            grp5 = sum(dist_grp == "80 < x ≤ 100") / n(),
            grp6 = sum(dist_grp == "100 < x ≤ 200") / n(),
            grp7 = sum(dist_grp == "200 < x ≤ 300") / n(),
            grp8 = sum(dist_grp == "> 300") / n()) %>%
  gather(key = dist_grp, value = prop, grp1:grp8)

#sum(ndd$prop)

ndd22$year <- 2022
ndd23$year <- 2023

ndd <- rbind(ndd22, ndd23)
```

## Plot NDD
```{r}
ggplot(ndd, aes(x = as.factor(dist_grp), y = prop, fill = as.factor(year))) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_fill_manual(values = c("palegreen3", "mediumpurple1"),
                    labels = c("2022", "2023"),
                    name = "Year\nbreeding") +
  scale_x_discrete(labels = c("0 < x ≤ 20", "20 < x ≤ 40", "40 < x ≤ 60", "60 < x ≤ 80",
                              "80 < x ≤ 100", "100 < x ≤ 200", "200 < x ≤ 300", "> 300")) +
  labs(x = "Natal dispersal distance (m)",
       y = "Proportion of breeding adults banded as chicks") +
  annotate("label", x = 6.75, y = 0.36, label = "n = 26 | mdn = 28.9m",
           fontface = "bold",
           col = "forestgreen", size = 6) +
  annotate("label", x = 6.75, y = 0.32, label = "n = 18 | mdn = 21.6m",
           fontface = "bold",
           col = "purple3", size = 6) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"))
```

## Plot parent-child pairings
```{r}
ggplot() +
  geom_sf(data = basemap, col = "grey65", fill = NA) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "2M8", ], shape = 21, fill = "dodgerblue",
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "8FF", ], shape = 21, fill = "coral",
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "8C7", ], shape = 24, fill = "dodgerblue",
          size = 3,
          inherit.aes = FALSE) +
  geom_sf(data = nests23_sf[nests23_sf$M.1 == "4FN", ], shape = 24, fill = "coral",
          size = 3,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "3T1", ], shape = 22, fill = "dodgerblue",
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "0FJ", ], shape = 22, fill = "coral",
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "2 E 2", ], shape = 23, fill = "dodgerblue",
          size = 4,
          inherit.aes = FALSE) +
  geom_sf(data = nests22_sf[nests22_sf$M.1 == "5KJ / 2AK", ], shape = 23, fill = "coral",
          size = 4,
          inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0012, max(nests22$Lat, na.rm = T) + 0.0005)) +
  annotate("label", x = -70.6186, y = 42.9927, label = "Parent", fontface = "bold",
           col = "dodgerblue", size = 6) +
  annotate("label", x = -70.6186, y = 42.9923, label = "Child", fontface = "bold",
           col = "coral", size = 6) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```




## Match birds with banding years
```{r}
indiv <- read.csv("./data/Deployed_Field_Readable_Marks.csv") %>%
  rename(Band = bandnumb)
allGulls <- merge(birds22, indiv[, c("Year", "Band")], by = c("Band")) # this loses some birds

```







## Alternative all-island nest maps
## Register Google API key
```{r, include=FALSE}
register_google(key = "AIzaSyBn1OxFq4DMK79J4qHmQoBvFlbHbeImABw")
```

## Create satellite map
```{r}
# retrieve Google map
Appledore <- get_map(c(-70.6142, 42.9886),
                     source = "google",
                     maptype = "satellite",
                     zoom = 16)

ggmap(Appledore) +
  geom_sf(data = nests22_sf, col = "white", inherit.aes = FALSE) +
  #geom_sf_label(data = nests22_sf, aes(label = NestID), inherit.aes = FALSE) +
  coord_sf(xlim = c(min(nests22$Long, na.rm = T) - 0.001, max(nests22$Long, na.rm = T) + 0.001),
           ylim = c(min(nests22$Lat, na.rm = T) - 0.0005, max(nests22$Lat, na.rm = T) + 0.0005)) +
  theme(axis.title = element_blank())
```

## Create topographic map
```{r}
# define bounding box
loc <- rbind(
  c(min(nests22$Long, na.rm = T) - 0.0015, min(nests22$Lat, na.rm = T) - 0.002),
  c(max(nests22$Long, na.rm = T) + 0.0015, max(nests22$Lat, na.rm = T) + 0.0015)
) %>%
  as.data.frame() %>%
  rename(Long = V1, Lat = V2)

loc_sf <- st_as_sf(loc,
                    coords = c("Long", "Lat"),
                    crs = 4326)

# get elevation data
elevation <- get_elev_raster(locations = loc_sf,
                             z = 14,
                             clip = "bbox")

elevation_df <- as.data.frame(rasterToPoints(elevation), xy = T) %>%
	na.omit()
colnames(elevation_df)[3] <- "elevation"

for(i in 1:nrow(elevation_df)) {
  if(elevation_df$elevation[i] <= 0.1) {
    elevation_df$elevation[i] = 0
  }
}

ggplot() +
  geom_tile(data = elevation_df, 
  			aes(x = x, y = y, fill = elevation)) +
  scale_fill_gradientn(colors = rev(etopo.colors(100)[30:89])) +
  geom_sf(data = nests22_sf, col = "black", size = 2, inherit.aes = FALSE) +
  coord_sf(expand = FALSE) +
  theme(axis.title = element_blank(),
        legend.position = "none")
```
