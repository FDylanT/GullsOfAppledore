---
title: "GoA Aggression Visualization & Analysis"
author: "Dylan Titmuss"
date: "9/17/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(naniar)
library(lme4)
library(lmerTest)
library(multcomp)
library(trend)
```

```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")

gbbg_all <- read.csv("data/behaviour_data.csv")

gbbg_all[gbbg_all == ""] <- NA

## doesn't really matter, not comparing across years atm
# gbbg_all$birdID[gbbg_all$birdID == "0T4 / X19G22"] <- "0T4"
# gbbg_all$birdID[gbbg_all$birdID == "1Z5 / X19G14"] <- "1Z5"

gbbg <- gbbg_all %>%
  filter(days_pre_hatch > 0) %>%        # excluding observations post-hatching
  filter(response >= 0) %>%             ### currently ignoring individuals w "-1" or "-2" scores
  # group_by(birdID, year) %>%
  # filter(n() >= 3) %>%
  mutate(birdID = as.factor(birdID),
         location_cat = as.factor(location_cat),
         bird_year = as.factor(paste(birdID, year, sep = "_")))

# convert all numerical cols to numeric
is_all_numeric <- function(x) {
  !any(is.na(suppressWarnings(as.numeric(na.omit(x))))) & is.character(x)
}
gbbg <- gbbg %>% 
  mutate_if(is_all_numeric, as.numeric)

str(gbbg)

gbbg$obs_num_cat <- NA

for(i in 1:nrow(gbbg)) {
  if(gbbg$obs_num[i] < 5) {
    gbbg$obs_num_cat[i] <- "<5"
  } else {
    gbbg$obs_num_cat[i] <- "5+"
  }
}

gbbg$obs_num_cat <- as.factor(gbbg$obs_num_cat)

gbbg_lat <- gbbg %>%
  filter(!str_detect(notes, "switched") | is.na(notes))
```

## Summary stats
```{r}
mean(gbbg$obs_num) # 2.45
sd(gbbg$obs_num) # 1.43

max(gbbg$obs_num)  # 8
```

## Run models
```{r}
# Response ~ DayBeforeHatch + DateOfHatch + Location + (1|Egg) + (1|ObsNumber) + (1|GullID)

# m0 <- lmer(response ~ days_pre_hatch + hatch1_cal + location_cat + (1|bird_year) + (1|egg_num) + (1|obs_num), data = gbbg)
# m00 <- lmer(response ~ days_pre_hatch + hatch1_cal + (1|bird_year) + (1|obs_num), data = gbbg)

# this runs
m1 <- lmer(response ~ days_pre_hatch + hatch1_cal + (1|bird_year), data = gbbg)
summary(m1)
anova(m1)

m1.1 <- lmer(latency ~ days_pre_hatch + hatch1_cal + (1|bird_year), data = gbbg_lat)
summary(m1.1)
anova(m1.1)

# this does not
m2 <- lmer(response ~ days_pre_hatch + (1|bird_year) + (1|obs_num), data = gbbg)

m2.1 <- lmer(latency ~ days_pre_hatch + (1|bird_year) + (1|obs_num), data = gbbg_lat)

# this runs
m3 <- lmer(response ~ days_pre_hatch + (1|bird_year) + (1|obs_num_cat), data = gbbg)
summary(m3)
anova(m3)
summary(m3)$coefficients
coef(m3)

plot(m3)
plot(summary(m3)$residuals)
  # (but this does not)
m3.1 <- lmer(latency ~ days_pre_hatch + (1|bird_year) + (1|obs_num_cat), data = gbbg_lat)

# this does not
m4 <- lmer(response ~ days_pre_hatch + hatch1_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg)

m4.1 <- lmer(latency ~ days_pre_hatch + hatch1_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg_lat)

# this runs
m5 <- lmer(response ~ hatch1_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg)
summary(m5)
anova(m5)

m5.1 <- lmer(latency ~ hatch1_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg_lat)
summary(m5.1)
```

## Habituation check
```{r}
habit <- gbbg %>%
  group_by(birdID, year) %>%
  filter(n() >= 3)

habit_lat <- habit %>%
  filter(!str_detect(notes, "switched") | is.na(notes))

# this indicates that days_pre_hatch is *NOT* significant
h1 <- lmer(response ~ days_pre_hatch + obs_num + (1|bird_year), data = habit)
summary(h1)
anova(h1)

h1.1 <- lmer(latency ~ days_pre_hatch + obs_num + (1|bird_year), data = habit_lat)
summary(h1.1)
anova(h1.1)

# this indicates that days_pre_hatch is *NOT* significant
h2 <- lmer(response ~ days_pre_hatch + hatch1_cal + obs_num + (1|bird_year), data = habit)
summary(h2)
anova(h2)

# this indicates that days_pre_hatch *IS* significant
h3 <- lmer(response ~ days_pre_hatch + obs_num_cat + (1|bird_year), data = habit)
summary(h3)
anova(h3)
```

## Plot
```{r}
gbbg_sum <- gbbg %>%
  group_by(days_pre_hatch) %>%
  summarize(response = mean(response))

ggplot(gbbg, aes(x = days_pre_hatch, y = response)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_reverse() +
  theme_classic()

ggplot(gbbg_sum, aes(x = days_pre_hatch, y = response)) +
  geom_smooth(method = "lm", col = "black", linetype = "22") +
  geom_point() +
  scale_x_reverse() +
  labs(y = "Mean defense score") +
  theme_classic()
```

## Geospatial comparison
```{r}
g1 <- lmer(response ~ days_pre_hatch + location_cat + (1|bird_year), data = gbbg)
summary(g1)
anova(g1)

summary(glht(g1, linfct = mcp(location_cat = "Tukey")), test = adjusted("fdr"))

g1.1 <- lmer(latency ~ days_pre_hatch + location_cat + (1|bird_year), data = gbbg_lat)
summary(g1.1)
anova(g1.1)

summary(glht(g1.1, linfct = mcp(location_cat = "Tukey")), test = adjusted("fdr"))
```

## Plot geospatial
```{r}
## two-panel (score & latency)
## categorical boxplots
```

## Mate presence
```{r}
mates <- gbbg %>%
  filter(!is.na(mate_present)) %>%
  group_by(bird_year) %>%
  filter(n_distinct(mate_present) >= 2) %>%
  ungroup()

mates_lat <- gbbg_lat %>%
  filter(!is.na(mate_present)) %>%
  group_by(bird_year) %>%
  filter(n_distinct(mate_present) >= 2) %>%
  ungroup()

i1 <- lmer(response ~ mate_present + (1|bird_year) + (1|days_pre_hatch), data = mates)
summary(i1)
anova(i1)

ggplot(gbbg[!is.na(mates$mate_present), ], aes(x = response, fill = mate_present)) +
  geom_histogram(position = "dodge") +
  theme_bw()

ggplot(gbbg[!is.na(mates$mate_present), ], aes(x = mate_present, y = response)) +
  geom_boxplot() +
  theme_bw()

i1.1 <- lmer(latency ~ mate_present + (1|bird_year) + (1|days_pre_hatch), data = mates_lat)
summary(i1.1)
anova(i1.1)
```

## Sex comparison
```{r}
sexes <- read_csv("data/GBBG_sexes.csv") %>%
  replace(. == "*", NA)

sum(sexes$Genetic_Sex_PHAB == sexes$Database_Sex, na.rm = TRUE)

for(i in 1:nrow(gbbg)) {
  gbbg$sex[i] <- ifelse(is.na(gbbg$sex[i]),
                     sexes$Genetic_Sex_PHAB[sexes$PFR == as.character(gbbg$birdID)[i]],
                     gbbg$sex)
}

gbbg %>%
  group_by(birdID) %>%
  summarise(sex = sex[1]) %>%
  count(sex)  # 16 F, 49 M

count(gbbg, sex)  # 46 obs F, 200 obs M

s1 <- lmer(response ~ days_pre_hatch + sex + (1|bird_year), data = gbbg)
summary(s1)
anova(s1)

summary(glht(s1, linfct = mcp(sex = "Tukey")), test = adjusted("fdr"))

s1.1 <- lmer(latency ~ days_pre_hatch + sex + (1|bird_year), data = gbbg_lat)
summary(s1.1)
anova(s1.1)

summary(glht(s1.1, linfct = mcp(sex = "Tukey")), test = adjusted("fdr"))
```







## Mann-Kendall fits
```{r}
ggplot(gbbg_sum, aes(x = response)) +
  geom_histogram() +
  theme_bw()

shapiro.test(gbbg_sum$response) # p-value = 0.5165

mk <- mk.test(gbbg_sum$response)
slope <- sens.slope(gbbg_sum$response)$estimates
intercept <- median(gbbg_sum$response) - 
             median(gbbg_sum$response) * slope

ggplot(gbbg_sum, aes(x = days_pre_hatch, y = response)) +
  geom_point() +
  labs(x = "Time to Hatch (days)", y = "Response Score") +
  scale_x_reverse() +
  theme_bw() +
  geom_abline(slope = -slope, intercept = intercept, col = "royalblue", linewidth = 1) +
  annotate("text",
           x = 3.5,
           y = 6.2,
           label = paste("slope =", -round(slope, 3)), col = "royalblue") +
  annotate("text",
           x = 3.5,
           y = 6.15,
           label = paste("p =", round(mk$p.value, 3)), col = "royalblue")

gbbg <- gbbg %>%
  mutate(year_frac = year + obs_date_cal / 365)

rk <- rkt(date = gbbg$year_frac,
          y = gbbg$response,
          block = as.numeric(factor(gbbg$bird_year)))

rk2 <- rkt(date = gbbg$year_frac,
          y = gbbg$response,
          block = as.numeric(factor(gbbg$obs_num)),
          rep = "m")
```

## Side analysis
```{r}
# difference between indiv birds across years (e.g. 7U9, etc.)
```









### Load 2021 data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")
aggData21 <- read.csv("./data/2021aggData.csv") %>%
  mutate(response = replace(response, response == "X", 8)) %>%
  mutate(response = as.numeric(response)) %>%
  mutate(birdID = factor(birdID, levels = c("0EE", "9Z4", "8EX", "4F7", "2EE", "6V4", "0T4", "6HU", "1K9", "9EF", "2E2", "U21G07", "0HZ", "2HZ", "1Z5", "5Y3", "0HX", "7JM", "3AP", "9AC", "1HY", "1C3", "7U9", "0AC", "7E6", "3HE", "2M8", "0FU", "3P2", "FED", "1M7", "9JP", "6R3", "4AC")))

count(aggData21, birdID)
```

### Load 2019 data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")
aggData19 <- read.csv("./data/2019aggData.csv") %>%
  na.omit()

# combine 2019 & 2020 data
agg19_21 <- aggData21 %>%
  select(-mate_present) %>%
  rbind(aggData19) %>%
  mutate(nestID = as.factor(nestID)) %>%
  mutate(days_pre_hatch = as.numeric(days_pre_hatch)) %>%
  mutate(year = as.factor(paste("20", str_extract(obs_date, "[0-9]{2}$"), sep = ""))) %>%
  mutate(birdNest = as.factor(paste(birdID, nestID, sep = "_"))) %>%
  mutate(birdYear = as.factor(paste(birdID, year, sep = "_")))
```

### Load 2018 data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")
aggData18 <- read.csv("./data/2018aggData.csv") %>%
  na.omit()

agg18_21 <- aggData18 %>%
  mutate(birdID = as.factor(birdID), nestID = as.factor(nestID)) %>%
  mutate(days_pre_hatch = as.numeric(days_pre_hatch)) %>%
  mutate(year = as.factor(paste("20", str_extract(obs_date, "[0-9]{2}$"), sep = ""))) %>%
  mutate(birdNest = as.factor(paste(birdID, nestID, sep = "_"))) %>%
  mutate(birdYear = as.factor(paste(birdID, year, sep = "_"))) %>%
  rbind(agg19_21)
```

### Analyze data (individuals with 3+ obs)

**1: Does aggression vary over the course of the breeding season? (i.e. Is aggression affected by incubation timepoint?)**

#### 2021 data
```{r}
m1 <- lmer(response ~ days_pre_hatch + (1|birdID), data = aggData21_3)
summary(m1)
anova(m1) # df = 1,44.019   # F = 14.194   # p = 0.0004864 (4.864e-4)
```

#### 2019 & 2021 data
```{r}
m2 <- lmer(response ~ days_pre_hatch + (1|birdNest) + (1|year), data = agg19_21_3)
summary(m2)
anova(m2)  # df = 1,121.38   # F = 21.55   # p = 0.000008796 (8.796e-6)

m3 <- lmer(response ~ days_pre_hatch + (1|birdNest), data = agg19_21_3)
anova(m2, m3) # AIC of 476.49 (m2) vs 476.97 (m3); p = 0.12 --> random effect of year makes no difference
```

#### 2018-2021 data
```{r}
agg18_21_3_filt <- agg18_21_3 %>%
  filter(days_pre_hatch >= 0) # filter out post-hatching observations

m5 <- lmer(response ~ days_pre_hatch + (1|birdNest) + (1|year), data = agg18_21_3_filt)
summary(m5)
anova(m5)
```

#### Out of curiosity -- run model including post-hatch obs
```{r}
agg19_21_3_unfilt <- agg19_21 %>%
  group_by(birdNest) %>% 
  filter(n() >= 3) %>% # filter out individuals with <3 obs
  ungroup()

m4 <- lmer(response ~ days_pre_hatch + (1|birdNest) + (1|year), data = agg19_21_3_unfilt)
summary(m4)
anova(m4)  # df = 1,182.72   # F = 4.022   # p = 0.04639
# still technically significant, but barely -- seems that aggression increases again after chicks have hatched
```

**2: How does aggression vary within mated pairs?**

### Check for patterns by nest ID
#### 2021 data
```{r}
ggplot(aggData21, aes(x = days_pre_hatch, y = response)) +
  geom_point() +
  geom_line(aes(lty = birdID)) +
  facet_wrap(~ nestID, ncol = 6) +
  scale_x_reverse() +
  ylim(1, 8) +
  scale_linetype_manual(values = c("solid", "22", "solid", "22", "solid", "22", "22", "solid", "solid", "22", "22", "solid", "solid", "22", "22", "solid", "solid", "22", "solid", "22", "22", "solid", "solid", "22", "solid", "22", "solid", "22", "solid", "22", "solid", "22", "solid", "22")) +
  labs(x = "Days Before First Hatch", y = "Aggression Response", title = "Aggression Over Time Among Mated Pairs") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 10),
        legend.position = "none")
```
