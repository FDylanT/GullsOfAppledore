---
title: "GoA Aggression Visualization & Analysis"
author: "Dylan Titmuss"
date: "9/17/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(lmerTest)
library(multcomp)
library(trend)
```

```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")

gbbg_all <- read.csv("data/aggData/behaviour_data.csv")
# count(gbbg_all, birdID, year)
# 147 individuals in *total* total

gbbg_all[gbbg_all == ""] <- NA

## doesn't really matter, not comparing across years atm
# gbbg_all$birdID[gbbg_all$birdID == "0T4 / X19G22"] <- "0T4"
# gbbg_all$birdID[gbbg_all$birdID == "1Z5 / X19G14"] <- "1Z5"

# list1 <- gbbg_all %>% count(birdID, year) %>% mutate(bird_year = as.factor(paste(birdID, year, sep = "_")))
# list2 <- gbbg %>% count(birdID, year) %>% mutate(bird_year = as.factor(paste(birdID, year, sep = "_")))
# 
# gbbg_all %>%
#   group_by(birdID, year) %>%
#   filter(max(days_pre_hatch) <= 0) %>%
#   count()
# # 9 individuals excluded bc only tested at/after hatching
# 
# gbbg_all %>%
#   group_by(birdID, year) %>%
#   filter(max(response) <= 0) %>%
#   count()
# # 5 individuals excluded bc only ever received negative score; one overlap w/ above
# 
# list3 <-
# gbbg_all %>%
#   group_by(birdID, year) %>%
#   filter(max(days_pre_hatch) <= 0 | max(response) <= 0) %>%
#   count()
# # total of above is 13 individuals
# 
# list1$birdID[!list1$birdID %in% list2$birdID & !list1$birdID %in% list3$birdID]
# # +1 individual w/ two obs: 1 negative score, 1 post-hatch
# # +1 individual w/ seven obs: 6 negative scores, 1 post-hatch

gbbg <- gbbg_all %>%
  filter(days_pre_hatch > 0 | is.na(days_pre_hatch)) %>%        # excluding observations post-hatching
  filter(response >= 0) %>%           ### currently ignoring individuals w "-1" or "-2" scores
  mutate(birdID = as.factor(birdID),
         location_cat = as.factor(location_cat),
         bird_year = as.factor(paste(birdID, year, sep = "_")))
# count(gbbg, bird_year)
# # 132 individuals included in any analyses

# convert all numerical cols to numeric
is_all_numeric <- function(x) {
  !any(is.na(suppressWarnings(as.numeric(na.omit(x))))) & is.character(x)
}
gbbg <- gbbg %>% 
  mutate_if(is_all_numeric, as.numeric)

str(gbbg)

gbbg$obs_num_cat <- ifelse(gbbg$obs_num < 5, "<5", "5+") %>%
  as.factor()

gbbg_lat <- gbbg %>%
  filter(!str_detect(notes, "switched") | is.na(notes))
```

## Summary stats
```{r}
count(gbbg, nestID) # n = 84 nests

count(gbbg, birdID, year) # n = 132 individuals

gbbg %>%
  group_by(birdID) %>%
  summarise(n = n_distinct(year)) %>%
  filter(n > 1)
# 18 individuals tested in multiple years

mean(gbbg$obs_num) # 2.51
sd(gbbg$obs_num) # 1.49

min(gbbg$obs_num)  # 1
max(gbbg$obs_num)  # 8

min(gbbg$obs_date_cal, na.rm = TRUE) # 140 = 20-May
max(gbbg$obs_date_cal, na.rm = TRUE) # 175 = 24-Jun

min(gbbg$hatch1_cal, na.rm = TRUE) # 145 = 25-May
max(gbbg$hatch1_cal, na.rm = TRUE) # 177 = 26-Jun
mean(gbbg$hatch1_cal, na.rm = TRUE) # 162 = 11-Jun
sd(gbbg$hatch1_cal, na.rm = TRUE) # 6 days

min(gbbg$days_pre_hatch, na.rm = TRUE) # 1
max(gbbg$days_pre_hatch, na.rm = TRUE) # 23
mean(gbbg$days_pre_hatch, na.rm = TRUE) # 8.510256
sd(gbbg$days_pre_hatch, na.rm = TRUE) # 5.512188

gbbg %>%
  group_by(birdID, year) %>%
  filter(n() >= 3) %>%
  ungroup() %>%
  group_by(nestID) %>%
  summarise(n = n_distinct(birdID)) %>%
  filter(n > 1)
# 18 instances of 3+ obs from each mate @ one nest

gbbg %>%
  group_by(year) %>%
  summarise(n = n_distinct(nestID)) # 28, 20, 17, 19 nests/year

gbbg %>%
  group_by(year) %>%
  summarise(n = n_distinct(birdID)) # 29, 38, 33, 32 individuals/year

count(gbbg, year) # 84, 129, 81, 129 tests/year
```

## Habituation check
```{r}
habit <- gbbg %>%
  group_by(birdID, year) %>%
  filter(n() >= 3)

count(habit)
# 80 instances of 3+ obs from one nest

habit_lat <- habit %>%
  filter(!str_detect(notes, "switched") | is.na(notes))

# this indicates that days_pre_hatch is *NOT* significant
h1 <- lmer(response ~ days_pre_hatch + obs_num + (1|bird_year), data = habit)
summary(h1)
anova(h1)

h1.1 <- lmer(latency ~ days_pre_hatch + obs_num + (1|bird_year), data = habit_lat)
summary(h1.1)
anova(h1.1)

# this indicates that days_pre_hatch is *NOT* significant
h2 <- lmer(response ~ days_pre_hatch + obs_date_cal + obs_num + (1|bird_year), data = habit)
summary(h2)
anova(h2)

# this indicates that days_pre_hatch *IS* significant
h3 <- lmer(response ~ days_pre_hatch + obs_num_cat + (1|bird_year), data = habit)
summary(h3)
anova(h3)
```

## Run models
```{r}
# Response ~ DayBeforeHatch + DateOfHatch + Location + (1|Egg) + (1|ObsNumber) + (1|GullID)

# m0 <- lmer(response ~ days_pre_hatch + obs_date_cal + location_cat + (1|bird_year) + (1|egg_num) + (1|obs_num), data = gbbg)
# m00 <- lmer(response ~ days_pre_hatch + obs_date_cal + (1|bird_year) + (1|obs_num), data = gbbg)

# this runs: USING THESE TWO
m1 <- lmer(response ~ days_pre_hatch + obs_date_cal + (1|bird_year), data = gbbg)
summary(m1)
anova(m1)

m1.1 <- lmer(latency ~ days_pre_hatch + obs_date_cal + (1|bird_year), data = gbbg_lat)
summary(m1.1)
anova(m1.1)

# this does not
m2 <- lmer(response ~ days_pre_hatch + (1|bird_year) + (1|obs_num), data = gbbg)

m2.1 <- lmer(latency ~ days_pre_hatch + (1|bird_year) + (1|obs_num), data = gbbg_lat)

# this runs
m3 <- lmer(response ~ days_pre_hatch + (1|bird_year) + (1|obs_num_cat), data = gbbg)
summary(m3)
anova(m3)
coef(m3)
plot(summary(m3)$residuals)

  # (but this does not)
m3.1 <- lmer(latency ~ days_pre_hatch + (1|bird_year) + (1|obs_num_cat), data = gbbg_lat)

# this does not
m4 <- lmer(response ~ days_pre_hatch + obs_date_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg)

m4.1 <- lmer(latency ~ days_pre_hatch + obs_date_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg_lat)

# this also does not
m5 <- lmer(response ~ obs_date_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg)

m5.1 <- lmer(latency ~ obs_date_cal + (1|bird_year) + (1|obs_num_cat), data = gbbg_lat)
```

## Plot
```{r}
# ggplot(gbbg, aes(x = days_pre_hatch, y = response)) +
#   geom_point() +
#   labs(x = "Days prior to hatching", y = "Defense score") +
#   theme_linedraw() +
#   theme(panel.grid = element_blank())

ggplot(gbbg[!is.na(gbbg$days_pre_hatch), ], aes(x = factor(days_pre_hatch, levels = 23:1), y = response)) +
  geom_boxplot() +
  labs(x = "Days prior to hatching", y = "Defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())

gbbg_days_sum <- gbbg %>%
  filter(!is.na(days_pre_hatch)) %>%
  group_by(days_pre_hatch) %>%
  summarise(defense = mean(response),
            sd = sd(response))

ggplot(gbbg_days_sum, aes(x = days_pre_hatch, y = defense)) +
  geom_smooth(method = "lm", col = "black", linetype = "22", linewidth = 0.75) +
  geom_point(shape = 5) +
  geom_errorbar(aes(ymin = defense - sd, ymax = defense + sd)) +
  scale_x_reverse() +
  labs(x = "Days prior to hatching", y = "Mean defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())

ggplot() +
  geom_boxplot(data = gbbg[!is.na(gbbg$days_pre_hatch), ],
               aes(x = factor(days_pre_hatch, levels = 23:1), y = response)) +
  geom_smooth(data = gbbg_days_sum, aes(x = rev(days_pre_hatch), y = defense),
              method = "lm", col = "black", linetype = "22", linewidth = 0.75) +
  geom_point(data = gbbg_days_sum, aes(x = rev(days_pre_hatch), y = defense),
             shape = 23) +
  labs(x = "Days prior to hatching", y = "Defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())

ggplot(gbbg, aes(x = factor(obs_date_cal, levels = 140:175), y = response)) +
  geom_boxplot() +
  scale_x_discrete(breaks = factor(seq(140, 175, by = 5)), drop = FALSE) +
  labs(x = "Calendar day", y = "Defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())

gbbg_cal_sum <- gbbg %>%
  group_by(obs_date_cal) %>%
  summarize(defense = mean(response),
            sd = sd(response))

ggplot(gbbg_cal_sum, aes(x = obs_date_cal, y = defense)) +
  geom_smooth(method = "lm", col = "black", linetype = "22", linewidth = 0.75) +
  geom_point(shape = 5) +
  geom_errorbar(aes(ymin = defense - sd, ymax = defense + sd)) +
  labs(x = "Calendar day", y = "Mean defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())

ggplot() +
  geom_boxplot(data = gbbg, aes(x = factor(obs_date_cal, levels = 140:175), y = response)) +
  geom_smooth(data = gbbg_cal_sum, aes(x = (obs_date_cal-139), y = defense),
              method = "lm", col = "black", linetype = "22", linewidth = 0.75) +
  geom_point(data = gbbg_cal_sum, aes(x = (obs_date_cal-139), y = defense),
             shape = 23) +
  scale_x_discrete(breaks = factor(seq(140, 175, by = 5)), drop = FALSE) +
  labs(x = "Calendar day", y = "Defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())
```

## Geospatial comparison
```{r}
g1 <- lmer(response ~ days_pre_hatch + location_cat + (1|bird_year), data = gbbg)
summary(g1)
anova(g1)

summary(glht(g1, linfct = mcp(location_cat = "Tukey")), test = adjusted("fdr"))

g1.1 <- lmer(latency ~ days_pre_hatch + location_cat + (1|bird_year), data = gbbg_lat)
summary(g1.1)
anova(g1.1)

summary(glht(g1.1, linfct = mcp(location_cat = "Tukey")), test = adjusted("fdr"))
```

## Plot geospatial
```{r}
## two-panel (score & latency)
## categorical boxplots

ggplot(gbbg, aes(x = factor(location_cat, levels = c("campus", "loose subcolony", "dense subcolony")),
                 y = response)) +
  geom_boxplot() +
  labs(x = "Nesting neighborhood", y = "Defense score") +
  theme_linedraw() +
  theme(panel.grid = element_blank())
```

## Mate presence
```{r}
mates <- gbbg %>%
  filter(!is.na(mate_present)) %>%
  group_by(bird_year) %>%
  filter(n_distinct(mate_present) >= 2)

count(mates) # 37 individuals w/ both mate-present & mate-absent tests

mates_lat <- gbbg_lat %>%
  filter(!is.na(mate_present)) %>%
  group_by(bird_year) %>%
  filter(n_distinct(mate_present) >= 2)

i1 <- lmer(response ~ mate_present + (1|bird_year) + (1|days_pre_hatch), data = mates)
summary(i1)
anova(i1)

ggplot(gbbg[!is.na(mates$mate_present), ], aes(x = response, fill = mate_present)) +
  geom_histogram(position = "dodge") +
  theme_bw()

ggplot(gbbg[!is.na(mates$mate_present), ], aes(x = mate_present, y = response)) +
  geom_boxplot() +
  theme_bw()

i1.1 <- lmer(latency ~ mate_present + (1|bird_year) + (1|days_pre_hatch), data = mates_lat)
summary(i1.1)
anova(i1.1)
```

## Sex comparison
```{r}
sexes <- read_csv("data/GBBG_sexes.csv") %>%
  replace(. == "*", NA)

sum(sexes$Genetic_Sex_PHAB == sexes$Database_Sex, na.rm = TRUE) # 17 matches of genetic w/ beh/morph

for(i in 1:nrow(gbbg)) {
  gbbg$sex[i] <- ifelse(is.na(gbbg$sex[i]),
                        sexes$Genetic_Sex_PHAB[sexes$PFR == as.character(gbbg$birdID)[i]],
                        gbbg$sex[i])
}

for(i in 1:nrow(gbbg_lat)) {
  gbbg_lat$sex[i] <- ifelse(is.na(gbbg_lat$sex[i]),
                            sexes$Genetic_Sex_PHAB[sexes$PFR == as.character(gbbg_lat$birdID)[i]],
                            gbbg_lat$sex[i])
}

gbbg %>%
  group_by(birdID) %>%
  summarise(sex = sex[1]) %>%
  count(sex)  # 23 F, 45 M

count(gbbg, sex)  # 94 obs F, 173 obs M

s1 <- lmer(response ~ days_pre_hatch + sex + (1|bird_year), data = gbbg)
summary(s1)
anova(s1)

summary(glht(s1, linfct = mcp(sex = "Tukey")), test = adjusted("fdr"))

s1.1 <- lmer(latency ~ days_pre_hatch + sex + (1|bird_year), data = gbbg_lat)
summary(s1.1)
anova(s1.1)

summary(glht(s1.1, linfct = mcp(sex = "Tukey")), test = adjusted("fdr"))
```







## Mann-Kendall fits
```{r}
ggplot(gbbg_sum, aes(x = response)) +
  geom_histogram() +
  theme_bw()

shapiro.test(gbbg_sum$response) # p-value = 0.5165

mk <- mk.test(gbbg_sum$response)
slope <- sens.slope(gbbg_sum$response)$estimates
intercept <- median(gbbg_sum$response) - 
             median(gbbg_sum$response) * slope

ggplot(gbbg_sum, aes(x = days_pre_hatch, y = response)) +
  geom_point() +
  labs(x = "Time to Hatch (days)", y = "Response Score") +
  scale_x_reverse() +
  theme_bw() +
  geom_abline(slope = -slope, intercept = intercept, col = "royalblue", linewidth = 1) +
  annotate("text",
           x = 3.5,
           y = 6.2,
           label = paste("slope =", -round(slope, 3)), col = "royalblue") +
  annotate("text",
           x = 3.5,
           y = 6.15,
           label = paste("p =", round(mk$p.value, 3)), col = "royalblue")

gbbg <- gbbg %>%
  mutate(year_frac = year + obs_date_cal / 365)

rk <- rkt(date = gbbg$year_frac,
          y = gbbg$response,
          block = as.numeric(factor(gbbg$bird_year)))

rk2 <- rkt(date = gbbg$year_frac,
          y = gbbg$response,
          block = as.numeric(factor(gbbg$obs_num)),
          rep = "m")
```

## Side analysis
```{r}
# difference between indiv birds across years (e.g. 7U9, etc.)
```









### Load 2021 data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")
aggData21 <- read.csv("./data/2021aggData.csv") %>%
  mutate(response = replace(response, response == "X", 8)) %>%
  mutate(response = as.numeric(response)) %>%
  mutate(birdID = factor(birdID, levels = c("0EE", "9Z4", "8EX", "4F7", "2EE", "6V4", "0T4", "6HU", "1K9", "9EF", "2E2", "U21G07", "0HZ", "2HZ", "1Z5", "5Y3", "0HX", "7JM", "3AP", "9AC", "1HY", "1C3", "7U9", "0AC", "7E6", "3HE", "2M8", "0FU", "3P2", "FED", "1M7", "9JP", "6R3", "4AC")))

count(aggData21, birdID)
```

### Load 2019 data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")
aggData19 <- read.csv("./data/2019aggData.csv") %>%
  na.omit()

# combine 2019 & 2020 data
agg19_21 <- aggData21 %>%
  select(-mate_present) %>%
  rbind(aggData19) %>%
  mutate(nestID = as.factor(nestID)) %>%
  mutate(days_pre_hatch = as.numeric(days_pre_hatch)) %>%
  mutate(year = as.factor(paste("20", str_extract(obs_date, "[0-9]{2}$"), sep = ""))) %>%
  mutate(birdNest = as.factor(paste(birdID, nestID, sep = "_"))) %>%
  mutate(birdYear = as.factor(paste(birdID, year, sep = "_")))
```

### Load 2018 data
```{r}
setwd("~/Desktop/Repos/GullsOfAppledore")
aggData18 <- read.csv("./data/2018aggData.csv") %>%
  na.omit()

agg18_21 <- aggData18 %>%
  mutate(birdID = as.factor(birdID), nestID = as.factor(nestID)) %>%
  mutate(days_pre_hatch = as.numeric(days_pre_hatch)) %>%
  mutate(year = as.factor(paste("20", str_extract(obs_date, "[0-9]{2}$"), sep = ""))) %>%
  mutate(birdNest = as.factor(paste(birdID, nestID, sep = "_"))) %>%
  mutate(birdYear = as.factor(paste(birdID, year, sep = "_"))) %>%
  rbind(agg19_21)
```

### Analyze data (individuals with 3+ obs)

**1: Does aggression vary over the course of the breeding season? (i.e. Is aggression affected by incubation timepoint?)**

#### 2021 data
```{r}
m1 <- lmer(response ~ days_pre_hatch + (1|birdID), data = aggData21_3)
summary(m1)
anova(m1) # df = 1,44.019   # F = 14.194   # p = 0.0004864 (4.864e-4)
```

#### 2019 & 2021 data
```{r}
m2 <- lmer(response ~ days_pre_hatch + (1|birdNest) + (1|year), data = agg19_21_3)
summary(m2)
anova(m2)  # df = 1,121.38   # F = 21.55   # p = 0.000008796 (8.796e-6)

m3 <- lmer(response ~ days_pre_hatch + (1|birdNest), data = agg19_21_3)
anova(m2, m3) # AIC of 476.49 (m2) vs 476.97 (m3); p = 0.12 --> random effect of year makes no difference
```

#### 2018-2021 data
```{r}
agg18_21_3_filt <- agg18_21_3 %>%
  filter(days_pre_hatch >= 0) # filter out post-hatching observations

m5 <- lmer(response ~ days_pre_hatch + (1|birdNest) + (1|year), data = agg18_21_3_filt)
summary(m5)
anova(m5)
```

#### Out of curiosity -- run model including post-hatch obs
```{r}
agg19_21_3_unfilt <- agg19_21 %>%
  group_by(birdNest) %>% 
  filter(n() >= 3) %>% # filter out individuals with <3 obs
  ungroup()

m4 <- lmer(response ~ days_pre_hatch + (1|birdNest) + (1|year), data = agg19_21_3_unfilt)
summary(m4)
anova(m4)  # df = 1,182.72   # F = 4.022   # p = 0.04639
# still technically significant, but barely -- seems that aggression increases again after chicks have hatched
```

**2: How does aggression vary within mated pairs?**

### Check for patterns by nest ID
#### 2021 data
```{r}
ggplot(aggData21, aes(x = days_pre_hatch, y = response)) +
  geom_point() +
  geom_line(aes(lty = birdID)) +
  facet_wrap(~ nestID, ncol = 6) +
  scale_x_reverse() +
  ylim(1, 8) +
  scale_linetype_manual(values = c("solid", "22", "solid", "22", "solid", "22", "22", "solid", "solid", "22", "22", "solid", "solid", "22", "22", "solid", "solid", "22", "solid", "22", "22", "solid", "solid", "22", "solid", "22", "solid", "22", "solid", "22", "solid", "22", "solid", "22")) +
  labs(x = "Days Before First Hatch", y = "Aggression Response", title = "Aggression Over Time Among Mated Pairs") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 10),
        legend.position = "none")
```
